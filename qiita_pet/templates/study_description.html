{% extends sitebase.html %}
{% block content %}

<!-- Upload section -->

<table border="0" style="vertical-align: middle; text-align:center; align:center; height: 150px; width: 100%;">
  <tr>
    <td style="vertical-align: middle; text-align:left; width: 50%;" colspan="2">
      <b>{{study_title}} ({{study_info['study_alias']}})</b>
      <br/>
      Samples: {{study_info['number_samples_promised']}}/{{study_info['number_samples_collected']}}
      <br/>
      Metadata: {{study_info['metadata_complete']}}
      <br/>
      {% if sls and not sls.startswith('failed') %}
        <b>Split library status:</b> {% raw sls %}
        <br/>
      {% end %}
      {% if sls and sls.startswith('success') %}
        <b>EBI status:</b> {{ebi_status}}
        <br/>
      {% end %}

      <!-- {'mixs_compliant': True,
      'reprocess': False,
      'emp_person_id': None,
      'funding': None,
      'vamps_id': None,
      'first_contact': '2014-09-22',
      'principal_investigator_id': 1L,
      'timeseries_type_id': 1L,
      'study_abstract':
      'Myrold_Alder_Fir',
      'spatial_series': None,
      'study_description': 'Myrold_Alder_Fir',
       'portal_type_id': 3L,
       'study_alias': 'Myrold_Alder_Fir',
       'most_recent_contact': None, 'lab_person_id': None, -->
    </td>
  </tr>
  <tr>
    <td style="vertical-align: middle; text-align:center; width: 50%;" colspan="2"><b>Upload files (max file size: {{max_upload_size}}Gb)</b></td>
  </tr>
  <tr>
    <td style="vertical-align: top; text-align:center; " colspan="2">
      <div style="height: 150px; width: 100%; background-color:lightgrey; border: 2px solid; border-radius: 25px;" class="resumable-drop-metadata" ondragenter="jQuery(this).addClass('resumable-dragover');" ondragend="jQuery(this).removeClass('resumable-dragover');" ondrop="jQuery(this).removeClass('resumable-dragover');">
        <p style="vertical-align: middle;">Drop files here to upload or <a class="resumable-browse-metadata"><u>select from your computer</u></a></p>
      </div>

      <div class="progress-metadata" style="display:none;">
        <table>
          <tr>
            <td width="100%"><div class="progress-container"><div class="progress-bar"></div></div></td>
            <td class="progress-text" nowrap="nowrap"></td>
            <td class="progress-pause" nowrap="nowrap">
              &nbsp;&nbsp;&nbsp;&nbsp;
              <a href="#" onclick="uploader.resumable.upload(); return(false);" class="progress-resume-link"><span class="glyphicon glyphicon-play"></span></a>
              &nbsp;&nbsp;&nbsp;&nbsp;
              <a href="#" onclick="uploader.resumable.pause(); return(false);" class="progress-pause-link"><span class="glyphicon glyphicon-pause"></span></a>
            </td>
          </tr>
        </table>
      </div>

      <div class="uploader-list-metadata" style="display:none;">
      </div>

      <div class="file-edit-container-sequences" style="display:none;">
      </div>

    </td>
  </tr>
  <tr><td colspan="2"><br/></td></tr>
  <tr><td colspan="2">
    Investigation type:
    <select name="investigation-type" id="investigation-type">
      {% for i in investigation_types %}
        <option value="{{i}}">{{i}}</option>
      {% end %}
    </select>
  </td></tr>
  <tr><td colspan="2"><br/></td></tr>
  <tr>
    <td colspan="2"><input type="button" class="btn btn-primary" value="Process files" onclick="process_files();"></td>
  </tr>
  <tr>
    <td style="vertical-align: middle; text-align:center;" colspan="2">{% raw msg %}</td>
  </tr>

  {% if ssb %}
  <tr><td><hr/></td></tr>
  <tr>
    <td style="vertical-align: middle; text-align:center;" colspan="2">
      This study has valid files, you can:
      &nbsp;&nbsp;
      <a class="btn btn-primary" href="/metadata_summary/?sample_template={{study_id}}&prep_template={{prep_template_id}}">Show metadata Summary</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      {% if sls and not sls.startswith('preprocessing') and not sls.startswith('success') %}
        <input type="button" class="btn btn-primary" value="Split libraries" onclick="split_libraries();">
        <input type="checkbox" name="rev_comp_mapping_barcodes" id="rev_comp_mapping_barcodes"> Use rev_comp_mapping_barcodes
      {% elif sls.startswith('preprocessing') %}
        <font color="red">Split library is running</font>
      {% elif sls.startswith('success') and user_level == 'admin' %}
        <a class="btn btn-primary" href="/ebi_submission/{{study_id}}">Submit EBI - Good luck!</a>
      {% end %}
    </td>
  </tr>

  <tr>
    <td><font color="red">
    {% if sls and sls.startswith('failed') %}
      {% raw sls %}
      <br/>
    {% end %}
    </font></td>
  </tr>

  {% end %}
</table>

<script src="/static/vendor/js/resumable.js"></script>
<script src="/static/vendor/js/resumable-uploader.js"></script>
<script src="/static/vendor/js/underscore.min.js"></script>

<script>
  var meta = { fileType: [] };
  var maxFileSize = {{max_upload_size}}; // in Gb
  var filetypes = {{filetypes}}
  uploader = (function($){
      return (new ResumableUploader(meta, $('.resumable-browse-metadata'), $('.resumable-drop-metadata'), $('.progress-metadata'), $('.uploader-list-metadata'), $('.file-edit-container-metadata'), maxFileSize, "{{study_id}}", filetypes));
    })(jQuery);

  {% for f in files %}
    uploader.addFile("{{f}}");
  {% end  %}

  function process_files() {
    // function to validate the input files to process metadata and submits to
    // post those values
    var all_inputfiles = $('select[id^="inputfile"]');

    if (all_inputfiles.length == 0) {
      alert("You need to upload some files");
    }

    function reset_vals() {
      // a reset vals function so we do not have these lines multiple times
      required_values = {'raw_sample_template': "", 'raw_prep_template': [], 'barcodes': [], 'forward seqs': [], 'reverse seqs': []}
      iterations = 0
    }

    reset_vals();

    all_inputfiles.each(function () {

      iterations += 1;

      if (this.value == "raw_sample_template") {
        if (required_values['raw_sample_template'] == "") {
          required_values['raw_sample_template'] = this.name;
        } else {
          alert("You can not have more than one sample template");
          reset_vals();
          return false;
        }
      } else {
        required_values[this.value].push(this.name)
      }

      if (iterations == all_inputfiles.length) {
        if (required_values['raw_sample_template'] == "") {
          alert("You should have at least one sample template")
          reset_vals();
          return false;
        }

        if (required_values['raw_prep_template'].length == 0) {
          alert("You should have at least one prep template")
          reset_vals();
          return false;
        }

        if (required_values['barcodes'].length == 0) {
          alert("You should have at least one barcodes file")
          reset_vals();
          return false;
        }

        if (required_values['barcodes'].length != required_values['forward seqs'].length) {
          alert("You should have the same number of barcodes and forward seqs")
          reset_vals();
          return false;
        }

        var form = $("<form>")
          .attr("action", window.location.href)
          .attr("method", "post")
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "raw_sample_template")
            .attr("value", required_values['raw_sample_template']))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "raw_prep_template")
            .attr("value", required_values['raw_prep_template']))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "barcodes")
            .attr("value", required_values['barcodes']))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "forward_seqs")
            .attr("value", required_values['forward seqs']))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "reverse_seqs")
            .attr("value", required_values['reverse seqs']))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "investigation-type")
            .attr("value", $("#investigation-type").val()));
        $("body").append(form);
        form.submit();
      }
    });
  }

  function split_libraries() {
    if (confirm("Are you sure you want to submit a split libraries job?")) {
      var form = $("<form>")
        .attr("action", "/study/preprocess")
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "study_id")
          .attr("value", "{{study_id}}"))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "raw_data_id")
          .attr("value", "{{vssb}}"))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "rev_comp_mapping_barcodes")
          .attr("value", $("#rev_comp_mapping_barcodes").is(':checked')));
      $("body").append(form);
      form.submit();
    }
  }
</script>

{% end %}
